var xmlHttp = (function() {

    var XMLHttpFactories = [
        function() {
            return new XMLHttpRequest()
        },
        function() {
            return new ActiveXObject("Msxml2.XMLHTTP")
        },
        function() {
            return new ActiveXObject("Msxml3.XMLHTTP")
        },
        function() {
            return new ActiveXObject("Microsoft.XMLHTTP")
        }
    ];

    function createXMLHTTPObject() {
        var xmlhttp = false;
        for (var i = 0; i < XMLHttpFactories.length; i++) {
            try { xmlhttp = XMLHttpFactories[i](); } catch (e) {
                continue;
            }
            break;
        }
        return xmlhttp;
    }

    function get(url, callback) {
        var req = createXMLHTTPObject();
        if (!req) return;
        req.open("GET", url, true);
        req.onreadystatechange = function() {
            if (req.readyState != 4) {
                return;
            }
            if (req.status != 200 && req.status != 304) {
                return;
            }
            callback(req);
        }
        req.send();
    }

    return {
        get: get
    };


})();

var Utils = (function() {

    function isTouchDevice() {
        return 'ontouchstart' in window // works on most browsers
            ||
            navigator.maxTouchPoints; // works on IE10/11 and Surface
    };

    function setArticleNum() {
        var articleWrapper = document.getElementById('articles');
        if (articleWrapper.querySelectorAll) {
            var articleNums = articleWrapper.querySelectorAll(".pulse-article-number");
            for (i = 0; i < articleNums.length; i++) {
                articleNums[i].innerText = i + 1;
            }
        }
    }

    function htmlUnescape(str){
        return str
            .replace(/&quot;/g, '"')
            .replace(/&#39;/g, "'")
            .replace(/&lt;/g, '<')
            .replace(/&gt;/g, '>')
            .replace(/&amp;/g, '&');
    }

    function appendStyle(css, _document) {
        var head = _document.getElementsByTagName("head")[0];
        var style = _document.createElement("style");
        style.type = "text/css";

        style.appendChild(_document.createTextNode(css));
        head.appendChild(style);
    };

    function shuffleArray(array) {
        if (array) {
            for (var i = array.length - 1; i > 0; i--) {
                var j = Math.floor(Math.random() * (i + 1));
                var temp = array[i];
                array[i] = array[j];
                array[j] = temp;
            }
            return array;
        }
    }

    function checkImgSrc(src) {
        if (src && !/.gif/i.test(src)) {
            src = 'https://img.washingtonpost.com/wp-apps/imrs.php?src=' + src + '&h=250&w=300';
        }
        return src;
    }

    function filterSponsorContent(contents) {
        var sponsorArray = [];
        contents.forEach(function(item, index) {
            if (item.hasOwnProperty('sponsor') && item.sponsor == true) {
                sponsorArray.push(item);
            }
        });
        return sponsorArray;
    }

    function trackingPixel(url) {
        var img = document.createElement('img');
        img.src = url + '?' + Math.floor(Math.random() * 10000000000);
        img.alt = "";
        img.border = 0;
        img.height = 1;
        img.width = 1;
        img.style.display = "none";
        document.body.appendChild(img);
    };

    function removeSponContent(content) {
        var contentArray = [];
        content.forEach(function(item, index) {
            if (!item.hasOwnProperty('sponsor') || item.sponsor != true) {
                contentArray.push(item);
            }
        });
        return contentArray;
    }

    function htmlDecode(input){
      var e = document.createElement('div');
      e.innerHTML = input;
      return e.childNodes.length === 0 ? "" : e.childNodes[0].nodeValue;
    }

    return {
        setArticleNum: setArticleNum,
        shuffleArray: shuffleArray,
        isTouchDevice: isTouchDevice,
        appendStyle: appendStyle,
        trackingPixel: trackingPixel,
        checkImgSrc: checkImgSrc,
        filterSponsorContent: filterSponsorContent,
        removeSponContent: removeSponContent,
        htmlUnescape : htmlUnescape,
        htmlDecode : htmlDecode
    }


})();

var Templates = (function() {

    // Javascript template engine by http://krasimirtsonev.com/
    function engine(html, options) {
        var re = /<%([^%>]+)?%>/g,
            reExp = /(^( )?(if|for|else|switch|case|break|{|}))(.*)?/g,
            code = 'var r=[];\n',
            cursor = 0,
            match;
        var add = function(line, js) {
            js ? (code += line.match(reExp) ? line + '\n' : 'r.push(' + line + ');\n') :
                (code += line != '' ? 'r.push("' + line.replace(/"/g, '\\"') + '");\n' : '');
            return add;
        }
        while (match = re.exec(html)) {
            add(html.slice(cursor, match.index))(match[1], true);
            cursor = match.index + match[0].length;
        }
        add(html.substr(cursor, html.length - cursor));
        code += 'return r.join("");';
        return new Function(code.replace(/[\r\t\n]/g, '')).apply(options);
    }

    var types = {
        base: '<div class="pulse-wrapper <%if(this.sponsorAll) {%>sponsor-all<%}%>">' +
            '<%if(this.headerScripts) {%>' +
            '<div className="pulse-header-scripts" style="display:none"><%this.headerScripts%></div>'+
            '<%}%>'+
            '<div class="pulse-media">' +
            '</div>' +
            '<div id="articles" class="pulse-article-list-wrapper" style="display:none;">' +
            '<%if(this.sponsorAny) {%>' +
            '<div class="pulse-label-sponsor">' +
            '<div class="pulse-article-label-small">Content from <%this.sponsorLabel%></div><i class="pulse-info-icon"></i><span class="pulse-info-popup">This content is paid for by an advertiser and published by WP BrandStudio. The Washington Post newsroom was not involved in the creation of this content. <a href="http://www.washingtonpost.com/sf/brand-connect/" rel="nofollow" target="_blank">Learn more about WP BrandStudio.</a></span>' +
            '</div>' +
            '<%}%>'+
            '<ul id="sponsored-article-list" class="pulse-article-list pulse-sponsor-article-list"></ul>' +
            '<%if(!this.sponsorAll) {%>' +
            '<div class="pulse-article-label">' +
            '<div class="pulse-article-label-small">Washington Post content selected by <%this.sponsorLabel%></div>' +
            '</div>' +
            '<%}%>'+
            '<ul id="article-list" class="pulse-article-list"></ul>' +
            '<%if(this.sponsorLogo && ( this.sponsorAll || this.sponsorNone ) ) {%>' +
            '<div class="pulse-footer">'+
            '<a href="<% this.clickThruURL %>" class="pulse-mobile-desc-link track-click" data-track="<% this.track_pixel %>" target="_blank">'+
            '<img src="<%this.sponsorLogo%>" alt="" class="pulse-mobile-footer-logo" style="border: 0px; width: <%this.sponsorLogoWidth%>%;">'+
            '</a>'+
            '</div>' +
            '<%}%>'+
            '</div>' +
            '<div class="pulse-tracking-wrapper" style="display:none;">'+
            '<%if(this.trackingScripts) {%>' +
            '<%this.trackingScripts%>'+
            '<%}%>'+
            '</div>' +
            '</div>',

        articles: '<%if(this.showArticles) {%>' +
            '<%for(var index in this.articles) {%>' +
            '<li class="pulse-article-list-item">' +
            '<div class="pulse-article-wrapper cf">' +
            '<div class="pulse-article-thumb-wrapper">' +
            '<a href="<%this.articles[index].url%><%this.urlParam%>" class="pulse-article-link track-click" data-track="<% this.client_tracking %>" target="<% this.linkTarget(index) %>">' +
            '<%if(this.articles[index].src) {%>' +
            '<img src="https://img.washingtonpost.com/wp-apps/imrs.php?src=<%this.articles[index].src%>&h=61&w=61" border="0" class="pulse-article-thumbnail" />' +
            '<%}%>' +
            '</a>' +
            '</div>' +
            '<div class="pulse-article-number"></div>' +
            '<div class="pulse-article-desc-wrapper">' +
            '<p class="pulse-article-desc">' +
            '<a href="<%this.articles[index].url%><%this.urlParam%>" class="pulse-article-link pulse-article-desc-link track-click" data-track="<% this.client_tracking %>" target="<% this.linkTarget(index) %>">' +
            '<% unescape(this.articles[index].title)%>' +
            '</a>' +
            '</p>' +
            '</div>' +
            '</div>' +
            '</li>' +
            '<%}%>' +
            '<%} else {%>' +
            '<p>none</p>' +
            '<%}%>',

        html: '<div>' +
            '<%this.ad.html%>' +
            '</div>',

        iframe: '<div>' +
            '<a href="<% this.clickThruURL %>" data-track="<% this.client_tracking %>" target="_blank" class="track-click" style="width: 300px; height: 250px; position: absolute;"></a>' +
            '<iframe src="<%this.ad.src%>" border="0" frameBorder="0" height="250" scrolling="no" width="300" style="border:0"></iframe>' +
            '</div>',

        image: '<div>' +
            '<a href="<% this.ad.url %>" data-track="<% this.client_tracking %>" class="track-click" target="_blank">' +
            '<%if(this.ad.src) {%>' +
            '<img src="<% this.checkImgSrc(this.ad.src) %>" alt="" border="0" style="border:0" />' +
            '<%}%>' +
            '</a>' +
            '</div>',

        video: '<div>' +
            '<div class="pulse-player-wrapper" data-videotracking=\'<% this.ad.videoTracking %>\'>' +
            '<i class="pulse-player-play-toggle"></i>' +
            '<i class="pulse-player-volume-toggle"></i>' +
            '<video class="pulse-player" data-current-time="0.25" data-poster="<% this.ad.poster_url %>" <%if(this.ad.autoplay){%>autoplay playsinline<%}%> >' +
            '<%if(this.ad.src) {%>' +
            '<source src="<%this.ad.src%>" type="video/mp4" />' +
            '<%}%>' +
            '</video>' +
            '</div>' +
            '</div>'

    }

    return {
        engine: engine,
        types: types
    };

})();

var Styles = {};

Styles["main"] = "@font-face{font-family:\"FranklinITCProBold\";font-style:normal;font-weight:400;src:url(\"https://css.washingtonpost.com/video/resources/assets/fonts/webtype/Franklin-ITC-Pro-Bold/e9e4c4dc-e548-4fef-9aa1-80c9cd0f02ce-2.eot?\") format(\"embedded-opentype\"),url(\"https://css.washingtonpost.com/video/resources/assets/fonts/webtype/Franklin-ITC-Pro-Bold/e9e4c4dc-e548-4fef-9aa1-80c9cd0f02ce-3.woff\") format(\"woff\"),url(\"https://css.washingtonpost.com/video/resources/assets/fonts/webtype/Franklin-ITC-Pro-Bold/e9e4c4dc-e548-4fef-9aa1-80c9cd0f02ce-1.ttf\") format(\"truetype\"),url(\"https://css.washingtonpost.com/video/resources/assets/fonts/webtype/Franklin-ITC-Pro-Bold/e9e4c4dc-e548-4fef-9aa1-80c9cd0f02ce-4.svg#web\") format(\"svg\")}@font-face{font-family:\"FranklinITCProLight\";font-style:normal;font-weight:400;src:url(\"https://css.washingtonpost.com/video/resources/assets/fonts/webtype/Franklin-ITC-Pro-Light/b147bee6-eb48-46e1-86e1-2538a46794b6-2.eot?\") format(\"embedded-opentype\"),url(\"https://css.washingtonpost.com/video/resources/assets/fonts/webtype/Franklin-ITC-Pro-Light/b147bee6-eb48-46e1-86e1-2538a46794b6-3.woff\") format(\"woff\"),url(\"https://css.washingtonpost.com/video/resources/assets/fonts/webtype/Franklin-ITC-Pro-Light/b147bee6-eb48-46e1-86e1-2538a46794b6-1.ttf\") format(\"truetype\"),url(\"https://css.washingtonpost.com/video/resources/assets/fonts/webtype/Franklin-ITC-Pro-Light/b147bee6-eb48-46e1-86e1-2538a46794b6-4.svg#web\") format(\"svg\")}@font-face{font-family:\"FranklinITCProThin\";src:url(\"https://css.washingtonpost.com/wp-stat/wapo-sass-assets/fonts/Franklin-ITC-Pro-Thin/56bcaf21-92ef-486a-836d-19f261762e57-2.eot\");src:url(\"https://css.washingtonpost.com/wp-stat/wapo-sass-assets/fonts/Franklin-ITC-Pro-Thin/56bcaf21-92ef-486a-836d-19f261762e57-2.eot?\") format(\"embedded-opentype\"),url(\"https://css.washingtonpost.com/wp-stat/wapo-sass-assets/fonts/Franklin-ITC-Pro-Thin/56bcaf21-92ef-486a-836d-19f261762e57-3.woff\") format(\"woff\"),url(\"https://css.washingtonpost.com/wp-stat/wapo-sass-assets/fonts/Franklin-ITC-Pro-Thin/56bcaf21-92ef-486a-836d-19f261762e57-1.ttf\") format(\"truetype\"),url(\"https://css.washingtonpost.com/wp-stat/wapo-sass-assets/fonts/Franklin-ITC-Pro-Thin/56bcaf21-92ef-486a-836d-19f261762e57-4.svg#web\") format(\"svg\");font-style:normal;font-weight:normal}\n" +
"\n" +
".cf:after{content:\" \";display:table}.cf:after{clear:both}.pulse-wrapper{background-color:#ffffff;box-sizing:border-box;font-family:\"FranklinITCProLight\", \"HelveticaNeue\", \"Helvetica Neue Light\", \"Helvetica Neue\", Helvetica, Arial, \"Lucida Grande\", sans-serif;overflow:hidden;width:300px;border-radius:4px;border:1px solid #e9e9e9;border-bottom-color:#d5d5d5;border-bottom-width:2px;margin:0 auto}.pulse-wrapper.sponsored,.pulse-sponsor-article-list{background-color:#eaeaea}.pulse-wrapper iframe,.pulse-wrapper img{vertical-align:bottom}.pulse-article-ad-click{display:block;position:absolute;top:0;left:0;width:100%;height:100%;background-image:url(https://img.washingtonpost.com/wp-stat/advertising/pseudo-static/images/blank.gif);background-repeat:no-repeat}.pulse-article-list{list-style:none;margin:0;padding:0}.pulse-article-list:after{content:\"\";display:table;clear:both}.pulse-article-list-item{float:right;width:100%}.pulse-article-list-item.sponsor{background-color:#e6e6e6}.pulse-article-wrapper{margin:10px}.pulse-article-label{font-family:\"FranklinITCProBold\", \"HelveticaNeue\", \"Helvetica Neue Light\", \"Helvetica Neue\", Helvetica, Arial, \"Lucida Grande\", sans-serif;margin:0;overflow:hidden;padding:10px}.pulse-article-label:before{background-color:#2A2A2A;content:\"\";display:block;font-family:\"FranklinITCProBold\", \"HelveticaNeue\", \"Helvetica Neue Light\", \"Helvetica Neue\", Helvetica, Arial, \"Lucida Grande\", sans-serif;height:0.25rem;margin-bottom:0.625rem;width:2rem}.pulse-article-logo{float:left;padding-left:10px;width:auto}.pulse-article-logo img{display:block}.pulse-article-logo-sm{position:relative;top:-2px;width:23px}.pulse-article-label-small{font-family:\"FranklinITCProMedium\", \"Helvetica Neue Light\", \"Helvetica Neue\", Helvetica, Roboto, Arial, sans-serif;font-size:10px}.pulse-label-sponsor{position:relative}.pulse-label-sponsor .pulse-article-label-small{background-color:#eaeaea;color:#666666;font-family:\"FranklinITCProBold\", \"HelveticaNeue\", \"Helvetica Neue Light\", \"Helvetica Neue\", Helvetica, Arial, \"Lucida Grande\", sans-serif;font-size:10px;padding:10px 10px 0 10px;text-transform:uppercase}i.pulse-info-icon{background-image:url(\"https://css.washingtonpost.com/wp-srv/ad/public/brandconnect/modulev3/images/glyphicons_195_circle_info_grey.png\");height:12px;width:12px;background-size:12px 12px;display:block;position:absolute;top:0px;right:0px;margin-top:10px;margin-right:10px}.pulse-info-popup{background-color:#d3d3d3;display:none;width:200px;position:absolute;line-height:1.2em;font-family:FranklinITCProLight,HelveticaNeue,Helvetica,Arial,sans-serif;top:3px;right:0px;margin-top:15px;margin-right:15px;font-size:9px;padding:10px;z-index:10;border:1px solid #000}.pulse-info-popup:hover{display:block}.pulse-info-icon:hover ~ span.pulse-info-popup{display:block}.pulse-info-popup a,.pulse-info-popup a:hover{color:#000000;text-decoration:underline}.pulse-label-sponsor-all{padding:20px 10px}.pulse-label-sponsor-all .pulse-article-label-small{padding:0}.pulse-label-sponsor-all .pulse-info-icon{margin-top:20px}.pulse-article-thumb-wrapper{box-sizing:border-box;float:left;padding-right:10px;width:auto}.pulse-article-thumb-border{border:1px solid #f0f0f0}.pulse-article-desc-wrapper{box-sizing:border-box;float:left;width:60%}.pulse-article-number{color:#333;font-family:\"FranklinITCProBold\", \"HelveticaNeue\", \"Helvetica Neue Light\", \"Helvetica Neue\", Helvetica, Arial, \"Lucida Grande\", sans-serif;font-size:24px;float:left;margin-top:-3px;padding-right:15px;padding-top:0;width:auto}.pulse-article-desc-header{font-family:\"FranklinITCProBold\", \"HelveticaNeue\", \"Helvetica Neue Light\", \"Helvetica Neue\", Helvetica, Arial, \"Lucida Grande\", sans-serif;font-size:18px;line-height:22px;margin:0;padding:0}.pulse-article-desc-link{text-decoration:none;color:inherit}.pulse-article-desc-link:hover{color:#2e6d9d}.pulse-article-cont-link{margin:10px 0 0 0;font-size:.7em}.pulse-article-desc{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;font-size:15px;line-height:17px;margin:0;padding:0}.pulse-article-thumbnail{vertical-align:middle;width:100%}.pulse-slideshow-wrapper{padding-top:10px}.pulse-slideshow-label{font-family:\"FranklinITCProBold\", \"HelveticaNeue\", \"Helvetica Neue Light\", \"Helvetica Neue\", Helvetica, Arial, \"Lucida Grande\", sans-serif;margin:5px 0;padding:0px 10px 5px 10px;overflow:hidden}.pulse-slideshow-label:before{background-color:#2A2A2A;content:\"\";display:block;font-family:\"FranklinITCProBold\", \"HelveticaNeue\", \"Helvetica Neue Light\", \"Helvetica Neue\", Helvetica, Arial, \"Lucida Grande\", sans-serif;height:0.25rem;margin-bottom:0.625rem;width:2rem}.pulse-slides{margin:0;width:300px;height:230px}.pulse-slideshow .pulse-slide{text-align:center}.pulse-slide-img{display:inline-block}.pulse-slide-img{position:relative}.pulse-slide-img-overlay{position:absolute;background:rgba(0,0,0,0.5);width:100%;height:100%;top:0}.pulse-slide-desc{position:absolute;width:75%;margin:0 12.5%;top:30%;color:#fff;text-align:center;font-weight:bold;font-size:19px}.pulse-slide-wp-logo{position:absolute;right:10px;bottom:10px}.pulse-slideshow .slick-slider{margin-bottom:0}.pulse-slideshow .slick-arrow{font-family:\"FontAwesome\"}.pulse-slideshow .slick-arrow{display:inline-block;font:normal normal normal 14px/1 FontAwesome;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;overflow:visible}.pulse-slideshow .slick-next{right:7px}.pulse-slideshow .slick-prev{left:7px}.pulse-slideshow .slick-prev:before,.pulse-slideshow .slick-next:before{font-family:inherit;font-size:2em;line-height:1;position:absolute;color:#e9e9e9;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.pulse-slideshow .slick-prev:before{content:\"\\f053\"}.pulse-slideshow .slick-next:before{content:\"\\f054\"}.pulse-footer{padding:5px 0;text-align:center}.sponsor-all .pulse-footer{background-color:#eaeaea}.pulse-footer-logo{max-width:260px}.pulse-slideshow-footer{margin:10px 0;text-align:center}.pulse-tracking-wrapper{display:none}\n" +
"\n" +
".pulse-player-wrapper{background-color:#000000;border-bottom:1px solid #e9e9e9;cursor:pointer;height:248px;position:relative;width:298px}.pulse-player{position:absolute;top:0;left:0;width:100%;height:100%}.pulse-player-dark .pulse-player-play-toggle,.pulse-player-dark .pulse-player-volume-toggle{color:#000000}.lt-ie10 .pulse-player-play-toggle,.lt-ie10 .pulse-player-volume-toggle,.pulse-player-no-ctrls .pulse-player-play-toggle,.pulse-player-no-ctrls .pulse-player-volume-toggle{display:none}.pulse-player-play-toggle{border:solid 6px #fff;display:block;height:60px;width:60px;position:absolute;left:50%;top:50%;margin-left:-30px;margin-top:-30px;z-index:3;border-radius:50%;box-shadow:0 0 6px 0 rgba(0,0,0,0.6),inset 0 0 6px 0 rgba(0,0,0,0.6);box-sizing:border-box;cursor:pointer}.pulse-player-active .pulse-player-play-toggle{opacity:0}.pulse-player-active:hover .pulse-player-play-toggle{opacity:.6}.pulse-player-play-toggle:after,.pulse-player-play-toggle:before{content:\"\";display:block;border:solid 20px #fff;border-width:1em 0 1em 1.6em;border-top-color:transparent;border-right-color:transparent;border-bottom-color:transparent;position:absolute;width:0;left:15px;top:9px}.pulse-player-active .pulse-player-play-toggle:after,.pulse-player-active .pulse-player-play-toggle:before{border:none;height:28px;width:8px;background-color:#fff;top:10px;left:13px;box-shadow:0 0 6px 0 rgba(0,0,0,0.6)}.pulse-player-play-toggle:before{border-left-color:rgba(0,0,0,0.6);-webkit-filter:blur(2px);filter:blur(2px)}.pulse-player-active .pulse-player-play-toggle:before{left:27px;background-color:#fff;-webkit-filter:none;filter:none}.pulse-player-volume-toggle{font-size:8px;display:block;height:1em;width:.4em;background-color:#fff;position:absolute;right:24px;bottom:14px;z-index:3}.pulse-player-volume-toggle:before{content:\"\";border:solid .5em #fff;position:absolute;margin-left:.05em;border-left-color:transparent;border-top-color:transparent;border-bottom-color:transparent;height:1em;top:50%;margin-top:-1em}.pulse-player-volume-toggle:after{content:\"\";display:block;height:.8em;width:.8em;border:double .8em #fff;position:absolute;left:0;top:50%;margin-top:-1.1em;font-weight:bold;border-top-color:transparent;border-left-color:transparent;border-bottom-color:transparent;border-radius:50%}.pulse-player-muted .pulse-player-volume-toggle:after{content:\"\\00d7\";position:absolute;left:.9em;top:0;font-size:1.6em;top:50%;margin-top:-.5em;line-height:1;font-weight:bold;color:#fff;border:none;font-style:normal}";

var PulseAd = (function() {

    var articles = bsAd.articles;
    var articleFeed = bsAd.feedUrl == 'false' ? '' : bsAd.feedUrl ;
    bsAd.headerScripts = bsAd.headerScripts ? Utils.htmlUnescape(bsAd.headerScripts) : '';
    bsAd.trackingScripts = bsAd.trackingScripts ? Utils.htmlUnescape(bsAd.trackingScripts) : '';
    bsAd.sponsorLogo = !bsAd.sponsorLogo.search(/^http[s]?/i) ? bsAd.sponsorLogo : false;
    bsAd.sponsorAll = bsAd.sponsorAll=="true" || bsAd.sponsorAll==true ? true : false;

    //var articles_spoonsored = Utils.filterSponsorContent(articles);
    //console.log(articles);
    //var sponsorAny = articles_spoonsored.length>0 ? true : false;
    //bsAd.sponsorAny = sponsorAny;

    function iniAdBase() {
        if (articleFeed) {
            xmlHttp.get(articleFeed, function(xhr) {
                // initializing slider base template
                articles = JSON.parse(xhr.responseText);
                applyBaseTemplate(articles);
                PulseArticles.init(articles);
            });

        } else if (articles) {
            // initializing slider base template
            articles = JSON.parse(articles);
            applyBaseTemplate(articles);
            PulseArticles.init(articles);
        }
    }

    function applyBaseTemplate(articles) {
        var articles_sponsored = Utils.filterSponsorContent(articles);
        var sponsorAny = articles_sponsored.length>0 ? true : false;
        var sponsorNone = articles_sponsored.length==0 ? true : false;

        bsAd.sponsorAny = sponsorAny;
        bsAd.sponsorNone = sponsorNone;

        var html = Templates.engine(Templates.types['base'],bsAd);
        document.body.insertAdjacentHTML("beforeend", html);
    }

    function applyStyles() {
        styles = Styles["main"];
        Utils.appendStyle(styles, document);
    }

    function init() {
        iniAdBase();
        applyStyles();
    }

    return {
        init: init
    };

})();

var PulseArticles = (function() {

    function initArticles(articles) {

        //console.log(articles);

        var linkClickPixel = bsAd.client_tracking;
        var maxLength = bsAd.maxLength || 3;
        var pulseTrackingWrapper = document.getElementsByClassName('pulse-tracking-wrapper')[0];
        var pulseMediaContainer = document.getElementsByClassName('pulse-media')[0];
        var selArticles;
        var shuffle = bsAd.shuffle=="true" || bsAd.shuffle==true ? true : false ;
        var sponsorAll = bsAd.sponsorAll || false;
        var urlParam = bsAd.urlParam;
        var ad = bsAd.ad;
        var articlesList =  document.getElementById('article-list');
        var articlesListSponsored =  document.getElementById('sponsored-article-list');
        var articleWrapper =  document.getElementById('articles');

        articles_spoonsored = Utils.filterSponsorContent(articles);
        articles = Utils.removeSponContent(articles);

        var sponsorAny = bsAd.sponsorAny;
        var sponsorNone = bsAd.sponsorNone;

        if (shuffle) {
            selArticles = Utils.shuffleArray(articles).slice(0, maxLength);
        } else {
            selArticles = articles.slice(0, maxLength);
        }

        var html = Templates.engine(Templates.types['articles'], {
            articles: selArticles,
            showArticles: true,
            sponsorAll: sponsorAll,
            client_tracking : bsAd.client_tracking,
            linkTarget: function(i) {
                return sponsorAll || this.articles[i].sponsor ? '_blank' : '_top';
            },
            urlParam: urlParam ? '?spon_con=' + urlParam : ''
        });

        var html_sponsored = Templates.engine(Templates.types['articles'], {
            articles: articles_spoonsored,
            showArticles: true,
            sponsorAll: sponsorAll,
            client_tracking : bsAd.client_tracking,
            linkTarget: function(i) {
                return sponsorAll || this.articles[i].sponsor ? '_blank' : '_top';
            },
            urlParam: urlParam ? '?spon_con=' + urlParam : ''
        });

        articlesList.innerHTML = html;
        articlesListSponsored.innerHTML = html_sponsored;

        articleWrapper.style.display = "block";
        Utils.setArticleNum();

        ad = JSON.parse(ad);

        if (ad && ad.type === 'video') {
            ad.videoTracking = {};
            ad.videoTracking.trackStart = ad.trackstart || null;
            ad.videoTracking.track25 = ad.track25 || null;
            ad.videoTracking.track50 = ad.track50 || null;
            ad.videoTracking.track75 = ad.track75 || null;
            ad.videoTracking.track100 = ad.track100 || null;
            ad.videoTracking = JSON.stringify(ad.videoTracking);
        }
        if (ad && ad.type === 'html') {
            ad.html = Utils.htmlDecode(ad.html);
        }

        if (ad) {
            var adHtml = Templates.engine(Templates.types[ad.type], {
                ad: ad,
                setAdClick: Utils.setAdClick,
                checkImgSrc: Utils.checkImgSrc,
                client_tracking : bsAd.client_tracking
            });
            pulseMediaContainer.innerHTML = adHtml;
        }

        // Tracking
        var trackItems = document.querySelectorAll('.track-click');
        for (var i = 0; i < trackItems.length; i++) {
            var pixel = trackItems[i].getAttribute('data-track');
            trackItems[i].addEventListener('click',function(){
                Utils.trackingPixel(pixel);
            })
        }

    }

    function init(articles) {
            initArticles(articles);
    }

    return {
        init: init
    };

})();

var PulsePlayer = (function() {

    var pluse_main = document.getElementsByClassName('pulse-wrapper')[0],
        pulse_wrapper = document.getElementsByClassName('pulse-player-wrapper'),
        isFirstClick = true,
        click_thru = bsAd.clickThruURL,
        has_video_ctrls = document.getElementsByClassName('pulse-player-no-ctrls').length > 0 ? false : true;
        video_length = 0;

    function advClickThru() {
        if (click_thru && click_thru !== "") {
            window.open(click_thru);
        }
    }

    function muteVideo(video, wrapper) {
        if (video.muted) {
            video.muted = false;
            wrapper.classList.remove('pulse-player-muted');

        } else {
            video.muted = true;
            wrapper.classList.add('pulse-player-muted');
        }
    }

    function bindVideoWrapper(video, wrapper, button) {

        var eventName = "click";
        if (Utils.isTouchDevice()) {
            eventName = "touchstart";
        }

        if (wrapper.length && !video.hasAttribute('autoplay')) {
            wrapper.addEventListener(eventName, function() {
                button.click();
                return false;
            });
            wrapper.on(eventName, function(e) {
                $video_play_button.click();
            });
        } else {
            video.addEventListener(eventName, function() {
                advClickThru();
                return false;
            });
        }
        // Autoplay Video
        if (video.hasAttribute('autoplay')) {
            video.setAttribute('playsinline','')
            video.setAttribute('playing', 'true');
            video.parentNode.classList.add('pulse-player-active');
            muteVideo(video, wrapper);
        }
    }

    function playVideo(video, wrapper, button) {

        if (isFirstClick) {
            video.load(); // becase video src is set dynamically
            wrapper.removeEventListener('click', function() {
                button.click();
            });

            isFirstClick = false;
            /*if ( click_thru!= null ){
                video.addEventListener('click', function(){
                    advClickThru();
                    return false;
                });
            }*/
        }
        if (video.paused || video.ended) {
            video.play();
            video.setAttribute('playing', 'true');

            video.parentNode.classList.add('pulse-player-active');


        } else {
            video.pause();
            video.removeAttribute('playing');
            video.parentNode.classList.remove('pulse-player-active');
        }
    }

    function setStartTime(video) {
        if (!video.getAttribute('poster') && video.getAttribute('data-current-time')) {
            video.currentTime = video.getAttribute('data-current-time');
        }
    }

    function initTracking(v,data) {
        var tracked_25 = tracked_50 = tracked_75 = false;
        if (data.trackStart){
            v.addEventListener('playing',function(){
                Utils.trackingPixel(data.trackStart);
                tracked_25 = tracked_50 = tracked_75 = false;
            });
        }
        if (data.track100){
            v.addEventListener('ended',function(){
                Utils.trackingPixel(data.track100);
            })
        }
        v.addEventListener('timeupdate',function(){
            var time = v.currentTime;

            if ( time/video_length > .25  && data.track25 && !tracked_25 ) {
                tracked_25 = true;
                Utils.trackingPixel(data.track25);
            }
            if ( time/video_length > .5  && data.track50 && !tracked_50 ) {
                tracked_50 = true;
                Utils.trackingPixel(data.track50);
            }
            if ( time/video_length > .75  && data.track75 && !tracked_75 ) {
                tracked_75 = true;
                Utils.trackingPixel(data.track75);
            }
        });
    }

    function videoEndEvents(video, wrapper) {
        //video.load();
        if (!video.getAttribute('poster') && video.getAttribute('data-current-time')) {
            video.currentTime = video.getAttribute('data-current-time');
        }
        if (has_video_ctrls) {
            video.parentNode.classList.remove('pulse-player-active');
        }
    }

    function bindFunctions() {
        Array.prototype.forEach.call(pulse_wrapper, function(el) {
            var video = el.getElementsByTagName('video')[0];
            var btn_play = el.querySelector('.pulse-player-play-toggle');
            var btn_mute = el.querySelector('.pulse-player-volume-toggle');
            btn_play.addEventListener('click', function() {
                playVideo(video, el, this)
            });
            btn_mute.addEventListener('click', function() {
                muteVideo(video, el, this)
            });
            bindVideoWrapper(video, el, btn_play);
            setStartTime(video);
            video.addEventListener('ended', function() {
                videoEndEvents(video, el);
            });

            video.addEventListener('loadedmetadata', function() {
                video_length = video.duration;
            });
            var trackingData = JSON.parse(el.getAttribute('data-videotracking'));
            initTracking(video,trackingData);

        });
    }

    function init() {
        bindFunctions();
    }

    return {
        init: init
    };

})();

var PulseTracking = (function() {

    // get video element and tracking object

    var videoId = document.getElementById('pulse-player');
    var pulsePlayerWrapper = document.getElementsByClassName('pulse-player-wrapper')[0];
    var pulseTrackingWrapper = document.getElementsByClassName('pulse-tracking-wrapper')[0];

    var videoTracking = pulsePlayerWrapper && pulsePlayerWrapper.getAttribute('data-videotracking');

    // set up tracking variables

    videoTracking = videoTracking && JSON.parse(videoTracking);

    if (typeof videoTracking !== 'undefined' && videoTracking) {
        var trackstart = videoTracking.trackstart || null,
            track100 = videoTracking.track100 || null,
            track25 = videoTracking.track25 || null,
            track50 = videoTracking.track50 || null,
            track75 = videoTracking.track75 || null;
    }

    // create tracking pixel

    function setTrackPixel(url) {

        var img = new Image();
        img.alt = '';
        img.border = 0;
        img.height = 1;
        img.width = 1;
        img.style.display = 'none';

        if (url) {
            url = url.replace(/%%CACHEBUSTER%%/gi, '');
            url += Math.floor(1E12 * Math.random()) + '?';
            img.src = url;
            pulseTrackingWrapper.appendChild(img);
        }

    }

    // calculate key frame quartiles and store using local storage

    function setKeyFrames(duration) {
        var quarter = (duration / 4).toFixed(1)
        sessionStorage.setItem('one', quarter)
        sessionStorage.setItem('two', (quarter * 2).toFixed(1))
        sessionStorage.setItem('three', (quarter * 3).toFixed(1))
    }

    // check video time and set tracking pixels

    function videoTimeUpdate() {

        var curTime = videoId.currentTime.toFixed(1);

        if (track25 && (curTime >= parseInt(sessionStorage.getItem('one')))) {
            setTrackPixel(track25);
            sessionStorage.setItem('one', null);
        } else if (track50 && (curTime >= parseInt(sessionStorage.getItem('two')))) {
            setTrackPixel(track50);
            sessionStorage.setItem('two', null);
        } else if (track75 && (curTime >= parseInt(sessionStorage.getItem('three')))) {
            setTrackPixel(track75);
            sessionStorage.setItem('three', null);
        }

    }

    // event: video end

    function videoEnd() {
        setTrackPixel(track100);
    }

    // event: video play

    function videoPlay() {
        setTrackPixel(trackstart);
        setKeyFrames(this.duration)
    }

    // event: video pause

    function videoPause() {
        console.log('video paused');
    }

    function bindEvents() {
        if (videoId) {
            videoId.addEventListener('ended', videoEnd, false);
            videoId.addEventListener('timeupdate', videoTimeUpdate, false);
            videoId.addEventListener('play', videoPlay, false);
            //videoId.addEventListener('pause', videoPause, false);
        }
    }

    function init() {
        bindEvents();

    }

    return {
        init: init
    };

})();

document.addEventListener('DOMContentLoaded', function(){
    PulseAd.init();
    PulsePlayer.init();
    PulseTracking.init();
} , false);
